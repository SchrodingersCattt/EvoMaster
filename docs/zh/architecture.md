# 架构概述

EvoMaster 是一个用于迭代完成科学实验任务的 Agent 系统，专注于 MLE、物理、具身智能等科学实验场景。

## 系统架构

```
EvoMaster/
├── evomaster/              # 核心库
│   ├── agent/              # Agent 组件
│   │   ├── agent.py        # BaseAgent, Agent 类
│   │   ├── context.py      # 上下文管理
│   │   ├── session/        # Session 实现
│   │   └── tools/          # 工具系统
│   ├── core/               # 工作流组件
│   │   ├── exp.py          # BaseExp 类
│   │   └── playground.py   # BasePlayground 类
│   ├── env/                # 环境管理
│   ├── skills/             # 技能系统
│   └── utils/              # 工具类（LLM, Types）
├── playground/             # Playground 实现
├── configs/                # 配置文件
└── docs/                   # 文档
```

## 三层架构

EvoMaster 遵循三层架构设计：

```
┌─────────────────────────────────────────────────┐
│                  Playground                      │
│  （工作流编排，并行执行）                          │
└────────────────────┬────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────┐
│                     Exp                          │
│  （单次实验执行，任务实例）                        │
└────────────────────┬────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────┐
│                    Agent                         │
│  （LLM + 工具 + 记忆，智能决策）                  │
└─────────────────────────────────────────────────┘
```

### 第一层：Playground

**BasePlayground** 是工作流编排器，负责：
- 配置加载和组件初始化
- Session 生命周期管理
- 多智能体协调和并行执行
- MCP 服务器连接
- 结果聚合

### 第二层：Exp

**BaseExp** 代表单次实验执行：
- 接收任务描述
- 创建 TaskInstance
- 运行 Agent 并收集轨迹
- 保存结果

### 第三层：Agent

**BaseAgent** 是智能核心：
- 管理对话（会话历史）
- 执行工具调用
- 处理上下文截断
- 记录执行轨迹

## 组件交互

```
┌────────────────────────────────────────────────────────────┐
│                        Playground                           │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │   LLM    │  │ Session  │  │  Tools   │  │  Skills  │  │
│  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  │
│       └─────────────┴─────────────┴─────────────┘         │
│                           │                                │
│                    ┌──────▼──────┐                        │
│                    │    Agent    │                        │
│                    └──────┬──────┘                        │
│                           │                                │
│                    ┌──────▼──────┐                        │
│                    │     Exp     │                        │
│                    └─────────────┘                        │
└────────────────────────────────────────────────────────────┘
```

## 关键设计原则

### 1. 关注点分离
- **Playground**：编排和生命周期
- **Exp**：单任务执行
- **Agent**：智能决策

### 2. 可扩展性
- 自定义 Playground 用于不同工作流
- 自定义 Agent 用于不同行为
- 通过 ToolRegistry 自定义工具
- MCP 协议支持外部工具

### 3. 线程安全
- 每个 Exp 有独立的 Agent 实例
- 并行执行在 Playground 层
- 线程安全的轨迹记录

### 4. 上下文管理
- 自动上下文截断
- 多种截断策略
- Token 计数支持

## 数据流

```
任务描述
   │
   ▼
┌─────────────────┐
│   Playground    │──────────────────────┐
│    setup()      │                      │
└───────┬─────────┘                      │
        │                                │
        ▼                                │
┌─────────────────┐                      │
│  创建 Agent     │◄── LLM, Session,     │
│                 │    Tools, Skills     │
└───────┬─────────┘                      │
        │                                │
        ▼                                │
┌─────────────────┐                      │
│   创建 Exp      │                      │
└───────┬─────────┘                      │
        │                                │
        ▼                                │
┌─────────────────┐                      │
│   Exp.run()     │                      │
│  ┌───────────┐  │                      │
│  │Agent.run()│  │                      │
│  │  └─step() │  │                      │
│  │    └─LLM  │  │                      │
│  │    └─Tool │  │                      │
│  └───────────┘  │                      │
└───────┬─────────┘                      │
        │                                │
        ▼                                │
┌─────────────────┐                      │
│   Trajectory    │◄─────────────────────┘
│    （结果）      │
└─────────────────┘
```

## 相关文档

- [Agent 模块](./agent.md)
- [Core 模块](./core.md)
- [Tools 模块](./tools.md)
- [Skills 模块](./skills.md)
- [LLM 模块](./llm.md)
